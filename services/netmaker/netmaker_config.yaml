---
# Install the nmctl cli tool on the localhost.
#
# Then install the nmctl cli tool on the Netmaker server.
# Then configure the networks on the Netmaker server.
# Install and configure netclient on the Netmaker server.

- name: Configure NMCTL on the localhost
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../../vars/vault.yaml
    - ../../vars/main.yaml
    - ../../vars/netmaker.yaml

  tasks:
    - name: Install the nmctl tool
      ansible.builtin.import_tasks: ./tasks/nmctl.yaml
      vars:
        check_for_admin: false


- name: Configure Netmaker on the server
  hosts: do_netmaker
  gather_facts: false
  vars_files:
    - ../../vars/vault.yaml
    - ../../vars/main.yaml
    - ../../vars/netmaker.yaml

  tasks:
    - name: Install the nmctl tool
      ansible.builtin.import_tasks: ./tasks/nmctl.yaml
      vars:
        check_for_admin: true

    - name: Configure networks on Netmaker
      ansible.builtin.import_tasks: ./tasks/nmctl_network.yaml

    - name: Configure enrollment keys on Netmaker
      ansible.builtin.import_tasks: ./tasks/nmctl_enrollment.yaml

    - name: Install the netclient tool on the Netmaker server
      ansible.builtin.import_tasks: ./tasks/netclient.yaml
      vars:
        - network_tag: "{{ netmaker_networks[0].enrollment_tags }}"
        - nc_hostname: "{{ netmaker_droplet.name }}"

  handlers:
    - name: Import netmaker handlers
      ansible.builtin.import_tasks: handlers/main.yaml
